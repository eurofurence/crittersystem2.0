{# templates/components/forms/_macros.twig #}

{% macro field(row, options = {}) %}
  {# options:
     - label: override label
     - help: help text
     - prefix: string (input-group prefix)
     - suffix: string (input-group suffix)
     - col: bootstrap grid class (e.g. "col-12 col-md-6")
  #}
  {% set col = options.col|default('col-12') %}
  <div class="{{ col }} mb-3">
    {{ form_label(row, options.label|default(null), {'label_attr': {'class': 'form-label'}}) }}

    {% set hasGroup = options.prefix is defined or options.suffix is defined %}
    {% if hasGroup %}<div class="input-group">{% endif %}
      {% if options.prefix is defined %}
        <span class="input-group-text">{{ options.prefix }}</span>
      {% endif %}

      {# Ensure form-control if not already set #}
      {% set cls = (row.vars.attr.class|default('') ~ ' form-control')|trim %}
      {{ form_widget(row, {'attr': row.vars.attr|merge({'class': cls}) }) }}

      {% if options.suffix is defined %}
        <span class="input-group-text">{{ options.suffix }}</span>
      {% endif %}
    {% if hasGroup %}</div>{% endif %}

    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}

    {{ form_errors(row) }}
  </div>
{% endmacro %}

{# ------------------------------------------------------------------------------------------------------------------ #}

{% macro datetime_local(row, options = {}) %}
  {% set col = options.col|default('col-12') %}
  <div class="{{ col }} mb-3">
    {{ form_label(row, options.label|default(null), {'label_attr': {'class': 'form-label'}}) }}

    {% set cls = (row.vars.attr.class|default('') ~ ' form-control')|trim %}
    {{ form_widget(row, {
      'type': 'datetime-local',
      'attr': row.vars.attr|merge({'class': cls})
    }) }}

    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}

    {{ form_errors(row) }}
  </div>
{% endmacro %}

{# ------------------------------------------------------------------------------------------------------------------ #}

{% macro range_slider(row, options = {}) %}
  {% set col = options.col|default('col-12') %}
  {% set id = row.vars.id %}
  {% set showValue = options.showValue|default(true) %}
  {% set valueTargetId = options.valueTargetId|default(id ~ '_value') %}

  <div class="{{ col }} mb-3">
    <div class="d-flex justify-content-between align-items-center">
      {{ form_label(row, options.label|default(null), {'label_attr': {'class': 'form-label mb-0'}}) }}
      {% if showValue %}
        <span class="badge text-bg-secondary" id="{{ valueTargetId }}"></span>
      {% endif %}
    </div>

    {{ form_widget(row, {
      'type': 'range',
      'attr': row.vars.attr|merge({
        'class': ((row.vars.attr.class|default('') ~ ' form-range')|trim),
        'min': options.min|default(0),
        'max': options.max|default(100),
        'step': options.step|default(1),
        'data-range-value-target': valueTargetId
      })
    }) }}

    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}

    {{ form_errors(row) }}
  </div>
{% endmacro %}

{# ------------------------------------------------------------------------------------------------------------------ #}

{% macro search_input(name, options = {}) %}
  {% set col = options.col|default('col-12') %}
  {% set id = options.id|default('search_' ~ name) %}
  <div class="{{ col }} mb-3">
    <label class="form-label" for="{{ id }}">{{ options.label|default('Search') }}</label>
    <input
      id="{{ id }}"
      name="{{ name }}"
      type="search"
      class="form-control"
      placeholder="{{ options.placeholder|default('Type to searchâ€¦') }}"
      autocomplete="off"
      data-search-debounce="{{ options.debounceMs|default(250) }}"
      {% if options.turboFrame is defined %}data-search-turbo-frame="{{ options.turboFrame }}"{% endif %}
    />
    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}
  </div>
{% endmacro %}

{# ------------------------------------------------------------------------------------------------------------------ #}

{% macro multi_select(name, choices, selected = [], options = {}) %}
  {% set col = options.col|default('col-12') %}
  {% set id = options.id|default('ms_' ~ name) %}
  <div class="{{ col }} mb-3">
    <label class="form-label" for="{{ id }}">{{ options.label|default(name) }}</label>

    <select
      id="{{ id }}"
      name="{{ name }}[]"
      class="form-select"
      multiple
      size="{{ options.size|default(6) }}"
      data-multiselect="1"
    >
      {% for value, label in choices %}
        <option value="{{ value }}" {% if value in selected %}selected{% endif %}>
          {{ label }}
        </option>
      {% endfor %}
    </select>

    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}
  </div>
{% endmacro %}

{# ------------------------------------------------------------------------------------------------------------------ #}

{% macro choice(row, options = {}) %}
  {# Renders ChoiceType select nicely with Bootstrap.
     options:
     - col, label, help
  #}
  {% set col = options.col|default('col-12') %}
  <div class="{{ col }} mb-3">
    {{ form_label(row, options.label|default(null), {'label_attr': {'class': 'form-label'}}) }}

    {% set cls = (row.vars.attr.class|default('') ~ ' form-select')|trim %}
    {{ form_widget(row, {'attr': row.vars.attr|merge({'class': cls}) }) }}

    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}

    {{ form_errors(row) }}
  </div>
{% endmacro %}

{# ------------------------------------------------------------------------------------------------------------------ #}

{% macro choice_multiple(row, options = {}) %}
  {# For ChoiceType multiple (select[multiple]) #}
  {% set col = options.col|default('col-12') %}
  <div class="{{ col }} mb-3">
    {{ form_label(row, options.label|default(null), {'label_attr': {'class': 'form-label'}}) }}

    {% set cls = (row.vars.attr.class|default('') ~ ' form-select')|trim %}
    {% set size = options.size|default(row.vars.attr.size|default(6)) %}

    {{ form_widget(row, {
      'attr': row.vars.attr|merge({
        'class': cls,
        'size': size,
        'data-multiselect': '1'
      })
    }) }}

    {% if options.help is defined %}
      <div class="form-text">{{ options.help }}</div>
    {% endif %}

    {{ form_errors(row) }}
  </div>
{% endmacro %}
